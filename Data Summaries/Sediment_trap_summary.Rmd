---
title: "Sediment Trap Summary"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
#
Author <- c("E Levine") #Change to your name
Database <- "SouthSDTP"  #Set the local database to use
Server = "localhost\\ERICALOCALSQL" #Set the local Server to use

##Sites of interest
Estuaries <- c("TB", "CR")

#Timeframe of summary
Report_start <- c("2022-12-01")
Report_end <- c("2024-11-30")

#Packages
if (!require("pacman")) {install.packages("pacman")}
#p_unlock()
pacman::p_load(odbc, DBI, dbplyr,
  tidyverse, dplyr,  stringr, #DF manipulation
  DT, openxlsx,         #Excel
  lubridate, zoo,         #Dates
  knitr, scales, gt, gtExtras, ggpubr, ggpattern, magick, 
  flextable, lmPerm, broom, rstatix, biostat,
  install = TRUE)

```

```{r DatabaseDownload}
# Connect to Local database server and pull all necessary data, then close connection 
con <- dbConnect(odbc(),
                    Driver = "SQL Server", 
                    Server = Server,
                    Database = Database,
                    Authentication = "ActiveDirectoryIntegrated")
#
FixedLocations <- tbl(con,in_schema("dbo", "FixedLocations")) %>%  collect() 
TripInfo <- tbl(con,in_schema("dbo", "TripInfo")) %>%  collect() 
SampleEvent <- tbl(con,in_schema("dbo", "SampleEvent")) %>%   collect()
SampleEventWQ <- tbl(con,in_schema("dbo", "SampleEventWQ")) %>%   collect()
SedimentTrap <- tbl(con,in_schema("dbo", "SedimentTrap")) %>%  collect() 
#
DBI::dbDisconnect(con)
#
```

```{r FigureFormatting}
#
Sites <- c("TB", "CR")
#Shared formatting for figure consistency
BaseForm <- theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA), #Add border
        axis.title = element_text(family = "serif", color = "black", size = 17), axis.title.x = element_text(margin = margin(t = 12)), #Adjust axis title and text
        axis.text = element_text(family = "serif", color = "black", size = 12), axis.text.x = element_text(angle = 45, hjust = 1),
        axis.line = element_line(color = "black"),
        axis.ticks.length.x = unit(0.10, "cm"),
        axis.ticks.length.y = unit(0.15, "cm"))
#
PlotTitle <- theme(plot.title = element_text(size = 13, family = "serif", margin = margin(b = 0.07, t = 0)))
#
#Color to station number
Stat_pal <- c(rgb(0, 0, 228, maxColorValue = 255), rgb(153, 0, 0, maxColorValue = 255), rgb(0, 118, 0, maxColorValue = 255), rgb(102, 0, 102, maxColorValue = 255), rgb(245, 0, 0, maxColorValue = 255), rgb(76, 153, 0, maxColorValue = 255), rgb(255, 128, 0, maxColorValue = 255), rgb(127, 0, 255, maxColorValue = 255))
Stations <- c("1" = "Station 1", "2" = "Station 2", "3" = "Station 3", "4" = "Station 4", 
              "5" = "Station 5", "6" = "Station 6", "7" = "Station 7", "8" = "Station 8") 
Station_fill <- scale_fill_manual("", labels = Stations, values = setNames(Stat_pal, 1:8), na.value = "#999999")
Station_color <- scale_color_manual("", labels = Stations, values = setNames(Stat_pal, 1:8), na.value = "#999999")
#
#
```

```{r Dataframe cleaning}
#
TripInfo <- TripInfo %>% mutate(TripDate = as.Date(TripDate))
#
Locations <- FixedLocations %>% 
  mutate(Station = as.numeric(StationNumber)) %>% 
  dplyr::select(FixedLocationID, Estuary, SectionName, Station) %>% distinct()  
#
##Measurements per cup/sample - filtration
Sediment <- SedimentTrap %>% filter(is.na(Volume)) %>% 
  mutate(Proportion = (CrucibleDW-TareCrucible)/((PanDryWeight - PanTareWeight) + (FilterDryWeight - FilterTareWeight))) %>%
  mutate(DeployedDate = as.Date(DeployedDate), 
         RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"), 
         NumDays = as.numeric(RetDate-DeployedDate),
         FixedLocationID = substring(SampleEventID, 19, 22), 
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         Plot_Date = as.Date(AnalysisDate + 14),
         Proportion = round((CrucibleDW-TareCrucible)/((PanDryWeight-PanTareWeight)+(FilterDryWeight-FilterTareWeight)),3),
         Type = as.factor(case_when(is.na(Proportion) ~ "Estimated", TRUE ~ "Calculated")),
         TotalWW = PanTareWeight + FilterTareWeight,
         TotalDW = (PanDryWeight - PanTareWeight) + (FilterDryWeight - FilterTareWeight),
         SampleAsh = AshWeight - TareCrucible,
         TotalAsh = case_when(is.na(Proportion) ~(AshWeight - TareCrucible)*(1/PortionofSample), TRUE ~ (AshWeight - TareCrucible)*(1/Proportion)),
         SamplePctOrg = ((TotalDW-round(SampleAsh,3))/TotalDW)*100,
         PctOrganic = ((TotalDW-round(TotalAsh,3))/TotalDW)*100,
         SampleOrgWt = TotalDW*(SamplePctOrg/100),
         OrganicWt = TotalDW*(PctOrganic/100)) %>%
  dplyr::select(CupSampleID, FixedLocationID,SampleEventID, DeployedDate,RetDate, AnalysisDate, Plot_Date, NumDays, Proportion, PortionofSample, Type, TotalWW, TotalDW, CrucibleDW, SampleAsh, TotalAsh, SampleOrgWt, OrganicWt, SamplePctOrg, PctOrganic) %>% 
  left_join(Locations, by = c("FixedLocationID")) %>%
  mutate(across(all_of(c("SampleOrgWt", "OrganicWt", "SamplePctOrg", "PctOrganic")), ~ifelse(.x < 0, 0, .x))) 
#
##Measurements per cup/sample - volumetrics
Volumes <- SedimentTrap %>% filter(!is.na(Volume)) %>% 
  dplyr::select(CupSampleID:DeployedDate, Volume, NumDrills:Comments) %>%
  mutate(DeployedDate = as.Date(DeployedDate), 
         RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"), 
         NumDays = as.numeric(RetDate-DeployedDate),
         FixedLocationID = substring(SampleEventID, 19, 22), 
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         Plot_Date = as.Date(AnalysisDate + 14)) %>% 
  dplyr::select(CupSampleID, FixedLocationID,SampleEventID, DeployedDate,RetDate, AnalysisDate, Plot_Date, NumDays, Volume) %>%
  left_join(Locations, by = c("FixedLocationID")) 
#
##Water quality data
SampleWQ <- SampleEventWQ %>% 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"), 
         FixedLocationID = substring(SampleEventID, 19, 22), 
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         Plot_Date = as.Date(AnalysisDate + 14),
         SecchiPercent = (Secchi / Depth) * 100) %>%
  dplyr::select(SampleEventWQID, FixedLocationID, SampleEventID, RetDate, AnalysisDate, Plot_Date, Temperature, Salinity, DissolvedOxygen, PercentDissolvedOxygen, pH, SecchiPercent, TurbidityYSI, TurbidityHach) %>%  
  left_join(Locations, by = c("FixedLocationID")) 
#
#
#
```

```{r Sediment monthly summaries}
#
#Sample = numbers from crucibles; Other is calculated to whole collection based on calculated proportion of sample used
Month_sedi <- full_join(Sediment %>% mutate(Station = as.factor(Station)) %>%
                          group_by(AnalysisDate, Plot_Date, RetDate, FixedLocationID, Estuary, SectionName, Station) %>% drop_na(TotalDW) %>% 
                          summarise(MeanRate = mean(TotalDW/(NumDays/28), na.rm = T),
                                    RateSD = sd(TotalDW/(NumDays/28), na.rm = T),
                                    SampleMeanOrganic = mean(SamplePctOrg, na.rm = T),
                                    SampleSDOrganic = sd(SamplePctOrg, na.rm = T),
                                    SampleMeanOrgWt = mean(SampleOrgWt/(NumDays/28), na.rm = T),
                                    SampleSDOrgWt = sd(SampleOrgWt/(NumDays/28), na.rm = T)),
                        Sediment %>% mutate(Station = as.factor(Station)) %>%
                          group_by(AnalysisDate, Plot_Date, RetDate, FixedLocationID, Estuary, SectionName, Station) %>% drop_na(TotalDW) %>% filter(Type == "Calculated") %>% 
                          summarise(MeanOrganic = mean(PctOrganic, na.rm = T),
                                    SDOrganic = sd(PctOrganic, na.rm = T),
                                    MeanOrgWt = mean(OrganicWt/(NumDays/28), na.rm = T),
                                    SDOrgWt = sd(OrganicWt/(NumDays/28), na.rm = T))) %>%
  mutate(Year = format(AnalysisDate, "%Y"), Month = format(AnalysisDate, "%m"))
#
Month_vol <- Volumes %>% mutate(Station = as.factor(Station)) %>% group_by(AnalysisDate, Plot_Date, RetDate, FixedLocationID, Estuary, SectionName, Station) %>% summarise(MonthVol = mean(Volume/(NumDays/28), na.rm = T))
#
Sedi_rate <- Month_sedi %>% ungroup() %>% dplyr::select(Estuary, Station, RetDate, contains("Rate")) %>% mutate(Helper = case_when(is.na(MeanRate) ~ "*", TRUE ~ NA))
#
Sedi_PctOrg <- Month_sedi %>% ungroup() %>% dplyr::select(Estuary, Station, RetDate, contains("Organic")) %>% mutate(SampleHelper = case_when(is.na(SampleMeanOrganic) ~ "*", TRUE ~ NA), Helper = case_when(is.na(MeanOrganic) ~ "*", TRUE ~ NA))
#
Sedi_OrgWt <- Month_sedi %>% ungroup() %>% dplyr::select(Estuary, Station, RetDate, contains("Wt")) %>% mutate(SampleHelper = case_when(is.na(SampleMeanOrgWt) ~ "*", TRUE ~ NA), Helper = case_when(is.na(MeanOrgWt) ~ "*", TRUE ~ NA))
```

```{r Sediment trap summary tables}
#
SedimentSumm_overall <- rbind(Sediment %>% 
  group_by(Estuary) %>%
  summarise(MeanRate = mean(TotalDW/(NumDays/28), na.rm = T),  sdRate = sd(TotalDW/(NumDays/28), na.rm = T),
            MinRate = min(TotalDW/(NumDays/28), na.rm = T), MaxRate = max(TotalDW/(NumDays/28), na.rm = T)) %>% mutate(Station = NA),
  Sediment %>% 
    group_by(Estuary, Station) %>%
    summarise(MeanRate = mean(TotalDW/(NumDays/28), na.rm = T),  sdRate = sd(TotalDW/(NumDays/28), na.rm = T),
              MinRate = min(TotalDW/(NumDays/28), na.rm = T), MaxRate = max(TotalDW/(NumDays/28), na.rm = T))) %>%
  arrange(Estuary, Station) %>% dplyr::select(Estuary, Station, everything()) 
#
PctOrgSumm_overall <- rbind(Sediment %>% 
  group_by(Estuary) %>%
  summarise(MeanPct = mean(PctOrganic, na.rm = T), sdPct = sd(PctOrganic, na.rm = T),
            MinPct = min(PctOrganic, na.rm = T), MaxPct = max(PctOrganic, na.rm = T),
            MeanSample = mean(SamplePctOrg, na.rm = T), sdSample = sd(SamplePctOrg, na.rm = T),
            MinSample = min(SamplePctOrg, na.rm = T), MaxSample = max(SamplePctOrg, na.rm = T)) %>% mutate(Station = NA),
  Sediment %>% 
    group_by(Estuary, Station) %>%
    summarise(MeanPct = mean(PctOrganic, na.rm = T),  sdPct = sd(PctOrganic, na.rm = T),
              MinPct = min(PctOrganic, na.rm = T), MaxPct = max(PctOrganic, na.rm = T),
            MeanSample = mean(SamplePctOrg, na.rm = T), sdSample = sd(SamplePctOrg, na.rm = T),
            MinSample = min(SamplePctOrg, na.rm = T), MaxSample = max(SamplePctOrg, na.rm = T))) %>%
  arrange(Estuary, Station) %>% dplyr::select(Estuary, Station, everything()) 
#
OrgWtSumm_overall <- rbind(Sediment %>% 
  group_by(Estuary) %>%
  summarise(MeanWt = mean(OrganicWt/(NumDays/28), na.rm = T), sdWt = sd(OrganicWt/(NumDays/28), na.rm = T),
            MinWt = min(PctOrganic, na.rm = T), MaxWt = max(PctOrganic, na.rm = T),
            MeanSample = mean(SamplePctOrg, na.rm = T), sdSample = sd(SamplePctOrg, na.rm = T),
            MinSample = min(SamplePctOrg, na.rm = T), MaxSample = max(SamplePctOrg, na.rm = T)) %>% mutate(Station = NA),
  Sediment %>% 
    group_by(Estuary, Station) %>%
    summarise(MeanWt = mean(OrganicWt/(NumDays/28), na.rm = T),  sdWt = sd(OrganicWt/(NumDays/28), na.rm = T),
              MinWt = min(OrganicWt/(NumDays/28), na.rm = T), MaxWt = max(OrganicWt/(NumDays/28), na.rm = T),
            MeanSample = mean(SampleOrgWt/(NumDays/28), na.rm = T), sdSample = sd(SampleOrgWt/(NumDays/28), na.rm = T),
            MinSample = min(SampleOrgWt/(NumDays/28), na.rm = T), MaxSample = max(SampleOrgWt/(NumDays/28), na.rm = T))) %>%
  arrange(Estuary, Station) %>% dplyr::select(Estuary, Station, everything()) 
#

#Lowest and highest sedimentation rate, % organic, and organic weight per station
MinMax_stations <- rbind(rbind(Month_sedi %>% group_by(Estuary, Station) %>% slice_min(order_by = MeanRate, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanRate) %>% mutate(Type = "Min Rate", Measure = "Sedimentation") %>% rename(Value = MeanRate),
                               Month_sedi %>% group_by(Estuary, Station) %>% slice_max(order_by = MeanRate, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanRate) %>% mutate(Type = "Max Rate", Measure = "Sedimentation") %>% rename(Value = MeanRate)),
                         rbind(Month_sedi %>% group_by(Estuary, Station) %>% slice_min(order_by = MeanOrganic, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanOrganic) %>% mutate(Type = "Min Percent", Measure = "Percent Organic") %>% rename(Value = MeanOrganic),
                               Month_sedi %>% group_by(Estuary, Station) %>% slice_max(order_by = MeanOrganic, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanOrganic) %>% mutate(Type = "Max Percent", Measure = "Percent Organic") %>% rename(Value = MeanOrganic)),
                         rbind(Month_sedi %>% group_by(Estuary, Station) %>% slice_min(order_by = MeanOrgWt, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanOrgWt) %>% mutate(Type = "Min Percent", Measure = "Organic Weight") %>% rename(Value = MeanOrgWt),
                               Month_sedi %>% group_by(Estuary, Station) %>% slice_max(order_by = MeanOrgWt, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanOrgWt) %>% mutate(Type = "Max Percent", Measure = "Organic Weight") %>% rename(Value = MeanOrgWt))) %>%
  dplyr::select(Measure, Estuary, Station, Type, Year, Month, Value) %>% arrange(Measure, Estuary, Station)
#
```

This report provides summary tables and figures for the sediment trap data at Tampa Bay and Caloosahatchee River stations from `r format(as.Date(Report_start), "%B %Y")` through `r format(as.Date(Report_end), "%B %Y")`.
\
\
Monthly data is standardized to a 28-day month unless otherwise noted.
\
\
Overall values are based on all data summarizes together. Data is extrapolated to the entire sample collected in most cases. Columns including "Sample" in the title are from crucible data and not extrapolated to the entire sample collected.  
\
`r SedimentSumm_overall  %>% mutate(across(where(is.numeric), round, digits = 2)) %>% as_grouped_data(groups = "Estuary") %>% flextable() %>% align(align = "center") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 1. Sedimentation rates (g/month) by station and overall during the project. Rates are standardized to 28-day months.")`
\
`r PctOrgSumm_overall %>% mutate(across(where(is.numeric), round, digits = 2)) %>% as_grouped_data(groups = "Estuary") %>% flextable() %>% align(align = "center") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.55) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 2. Percent organic content (%) by station and overall during the project. Sample columns use crucible level data while other columns extrapolate measurements to the entire sample based on calculated proportions.")`
\
`r OrgWtSumm_overall %>% mutate(across(where(is.numeric), round, digits = 2)) %>% as_grouped_data(groups = "Estuary") %>% flextable() %>% align(align = "center") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.6) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 3. Organic weight (g/day) of sediment by station and overall during the project. Sample columns use crucible level data while other columns extrapolate measurements to the entire sample based on calculated proportions. Values are standardized to 28-day months.")`
\
`r MinMax_stations %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% merge_v(j = c("Measure", "Estuary", "Station")) %>% hline(part = "body") %>% align(align = "center") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.8) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 4. Minimum and maximum sedimentation rates, percent organic content, and organic weight per station and the Month and Year in which the minimum or maximum occurred.")`
\
```{r Sedimentation rate, fig.cap = "**Figure 1.**  Mean monthly sedimentation rate (± S.D.) at stations in Tampa Bay and Caloosahatchee River. Asterisks indicate when no samples were collected from a station. Please note differences in magnitude between the y-axes.", fig.height = 9.5, fig.width = 8, fig.fullwidth=TRUE}
#
###Monthly sedimentation rate
Sedi_list <- list()
for(i in seq_along(Sites)){
  #
  Working_site <- paste(Sites[i])
  df_temp <- Sedi_rate %>% filter(grepl(Working_site, Estuary)) %>% rowwise() %>% mutate(Upper = sum(MeanRate, RateSD, na.rm = TRUE))
  df_temp$HelperLocation <- (ceiling(max(df_temp$Upper, na.rm = T)*1.05)/5)
  max_upper <- ceiling(max(df_temp$Upper, na.rm = T)*1.05) #*1.05 adds 5% buffer to top if needed
  #
  Sedi_list[[i]] <- df_temp %>% ggplot(aes(RetDate, MeanRate, fill = Station, color = Station))+ 
    geom_errorbar(aes(ymin = MeanRate, ymax = MeanRate + RateSD), color = "black", position = position_dodge(12, preserve = "single"), width = 9) +
    geom_col(position = position_dodge(12, preserve = "single"), width = 9) +
    geom_text(aes(y = HelperLocation, label = Helper, color = Station), position = position_dodge(12, preserve = "single"), size = 8) +
    scale_x_date("Date", expand= c(0.005,0), date_breaks = "2 months", date_labels = "%b %Y", limits = c(floor_date(min(TripInfo$TripDate), "month"), ceiling_date(max(TripInfo$TripDate), "month") %m-% days(1)))+
    scale_y_continuous("Sedimentation rate (g/month)", expand = c(0,0), limits = c(0, max(pretty(0:ceiling(max_upper*10)/10))), breaks = pretty(0:ceiling(max_upper*10)/10))+
    ggtitle(paste0(case_when(grepl("TB", Working_site) ~ "Tampa Bay", grepl("CR", Working_site) ~ "Caloosahatchee River", TRUE ~ "WRONG"))) +
    Station_fill + Station_color + BaseForm + PlotTitle
}

Sedi_rate_fig <- ggarrange(
  Sedi_list[[1]] + rremove("x.text") + rremove("x.title") + rremove("y.title") + guides(color = guide_legend(override.aes = list(size=2))),
  Sedi_list[[2]] + rremove("x.title") + rremove("y.title") + guides(color = guide_legend(override.aes = list(size=2))),
  nrow = 2, heights = c(1, 1.1), align = "v"  
  )

annotate_figure(Sedi_rate_fig, left = text_grob("Sedimentation Rate (g/month)", rot = 90, vjust = 0.4, family = "serif", size = 18, color = "black"))

```

```{r Percent organic per crucible, fig.cap = "**Figure 2.**  Monthly organic content (%) of sediment at stations in Tampa Bay and Caloosahatchee River. Values are based on crucible samples. Asterisks indicate when no samples were collected from a station.", fig.height = 9.5, fig.width = 8, fig.fullwidth=TRUE}
#
Sedi_org_list <- list()
for(i in seq_along(Sites)){
  #
  Working_site <- paste(Sites[i])
  max_upper <- ceiling(max((Sedi_PctOrg %>% rowwise() %>% mutate(Upper = sum(SampleMeanOrganic, SampleSDOrganic, na.rm = TRUE)))$Upper, na.rm = T)*1.05) #*1.05 adds 5% buffer to top if needed
  df_temp <- Sedi_PctOrg %>% filter(grepl(Working_site, Estuary))
  df_temp$HelperLocation <- (ceiling(max((Sedi_PctOrg %>% rowwise() %>% mutate(Upper = sum(SampleMeanOrganic, SampleSDOrganic, na.rm = TRUE)))$Upper, na.rm = T)*1.05))/5
  #
  Sedi_org_list[[i]] <- df_temp %>% ggplot(aes(RetDate, SampleMeanOrganic, fill = Station, color = Station))+ 
    geom_errorbar(aes(ymin = SampleMeanOrganic, ymax = SampleMeanOrganic + SampleSDOrganic), color = "black", position = position_dodge(13, preserve = "single"), width = 12) +
    geom_col(position = position_dodge(13, preserve = "single"), width = 10) +
    geom_text(aes(y = HelperLocation, label = SampleHelper, color = Station), position = position_dodge(13, preserve = "single"), size = 8) +
    scale_x_date("Date", expand= c(0,0), date_breaks = "1 month", date_labels = "%b %Y", limits = c(floor_date(min(TripInfo$TripDate), "month"), ceiling_date(max(TripInfo$TripDate), "month") %m-% days(1)))+
    scale_y_continuous("Organic Content (%)", expand = c(0,0), limits = c(0, max(pretty(0:ceiling(max_upper*10)/10))), breaks = pretty(0:ceiling(max_upper*10)/10))+
    ggtitle(paste0(case_when(grepl("TB", Working_site) ~ "Tampa Bay", grepl("CR", Working_site) ~ "Caloosahatchee River", TRUE ~ "WRONG"))) +
    Station_fill + Station_color + BaseForm + PlotTitle
}

Sedi_org_fig <- ggarrange(
  Sedi_org_list[[1]] + rremove("x.text") + rremove("x.title") + rremove("y.title") + guides(color = guide_legend(override.aes = list(size=2))),
  Sedi_org_list[[2]] + rremove("x.title") + rremove("y.title") + guides(color = guide_legend(override.aes = list(size=2))),
  nrow = 2, heights = c(1, 1.1), align = "v"  
  )

annotate_figure(Sedi_org_fig, left = text_grob("Organic Content (%)", rot = 90, vjust = 0.4, family = "serif", size = 18, color = "black"))

```

```{r Percent organic per sample, fig.cap = "**Figure 3.**  Monthly organic content (%) of sediment at stations in Tampa Bay and Caloosahatchee River. Values are extrapolated to the entire samples. Asterisks indicate when no samples were collected from a station.", fig.height = 9.5, fig.width = 8, fig.fullwidth=TRUE}
#
Sedi_org_list_all <- list()
for(i in seq_along(Sites)){
  #
  Working_site <- paste(Sites[i])
  max_upper <- ceiling(max((Sedi_PctOrg %>% rowwise() %>% mutate(Upper = sum(MeanOrganic, SDOrganic, na.rm = TRUE)))$Upper, na.rm = T)*1.05) #*1.05 adds 5% buffer to top if needed
  df_temp <- Sedi_PctOrg %>% filter(grepl(Working_site, Estuary))
  df_temp$HelperLocation <- (ceiling(max((Sedi_PctOrg %>% rowwise() %>% mutate(Upper = sum(MeanOrganic, SDOrganic, na.rm = TRUE)))$Upper, na.rm = T)*1.05))/5
  #
  Sedi_org_list_all[[i]] <- df_temp %>% ggplot(aes(RetDate, MeanOrganic, fill = Station, color = Station))+ 
    geom_errorbar(aes(ymin = MeanOrganic, ymax = MeanOrganic + SDOrganic), color = "black", position = position_dodge(13, preserve = "single"), width = 12) +
    geom_col(position = position_dodge(13, preserve = "single"), width = 10) +
    geom_text(aes(y = HelperLocation, label = Helper, color = Station), position = position_dodge(13, preserve = "single"), size = 8) +
    scale_x_date("Date", expand= c(0,0), date_breaks = "1 month", date_labels = "%b %Y", limits = c(as.Date("2024-04-15"), ceiling_date(max(TripInfo$TripDate), "month") %m-% days(1)))+
    scale_y_continuous("Organic Content (%)", expand = c(0,0), limits = c(0, max(pretty(0:ceiling(max_upper*10)/10))), breaks = pretty(0:ceiling(max_upper*10)/10))+
    ggtitle(paste0(case_when(grepl("TB", Working_site) ~ "Tampa Bay", grepl("CR", Working_site) ~ "Caloosahatchee River", TRUE ~ "WRONG"))) +
    Station_fill + Station_color + BaseForm + PlotTitle
}

Sedi_org_fig_all <- ggarrange(
  Sedi_org_list_all[[1]] + rremove("x.text") + rremove("x.title") + rremove("y.title") + guides(color = guide_legend(override.aes = list(size=2))),
  Sedi_org_list_all[[2]] + rremove("x.title") + rremove("y.title") + guides(color = guide_legend(override.aes = list(size=2))),
  nrow = 2, heights = c(1, 1.1), align = "v"  
  )

annotate_figure(Sedi_org_fig_all, left = text_grob("Organic Content (%)", rot = 90, vjust = 0.4, family = "serif", size = 18, color = "black"))

```