---
title: "Sediment Trap Summary"
date: "`r Sys.Date()`"
output: 
  word_document:
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
#
Author <- c("E Levine") #Change to your name
Database <- "SouthSDTP"  #Set the local database to use
Server = "localhost\\ERICALOCALSQL" #Set the local Server to use

##Sites of interest
Estuaries <- c("TB", "CR")

#Timeframe of summary
Report_start <- c("2022-12-01")
Report_end <- c("2024-11-30")

#Packages
if (!require("pacman")) {install.packages("pacman")}
#p_unlock()
pacman::p_load(odbc, DBI, dbplyr,
  tidyverse, dplyr,  stringr, #DF manipulation
  DT, openxlsx,         #Excel
  lubridate, zoo,         #Dates
  knitr, scales, gt, gtExtras, ggpubr, ggpattern, magick, 
  flextable, lmPerm, broom, rstatix, biostat, rcompanion,
  install = TRUE)
#
```

```{r DatabaseDownload, include=FALSE}
# Connect to Local database server and pull all necessary data, then close connection 
con <- dbConnect(odbc(),
                    Driver = "SQL Server", 
                    Server = Server,
                    Database = Database,
                    Authentication = "ActiveDirectoryIntegrated")
#
FixedLocations <- tbl(con,in_schema("dbo", "FixedLocations")) %>%  collect() 
TripInfo <- tbl(con,in_schema("dbo", "TripInfo")) %>%  collect() 
SampleEvent <- tbl(con,in_schema("dbo", "SampleEvent")) %>%   collect()
SampleEventWQ <- tbl(con,in_schema("dbo", "SampleEventWQ")) %>%   collect()
SedimentTrap <- tbl(con,in_schema("dbo", "SedimentTrap")) %>%  collect() 
#
DBI::dbDisconnect(con)
#
```

```{r FigureFormatting, include=FALSE}
#
Sites <- c("TB", "CR")
#Shared formatting for figure consistency
BaseForm <- theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA), #Add border
        axis.title = element_text(family = "serif", color = "black", size = 17), axis.title.x = element_text(margin = margin(t = 12)), #Adjust axis title and text
        axis.text = element_text(family = "serif", color = "black", size = 12),
        axis.line = element_line(color = "black"),
        axis.ticks.length.x = unit(0.10, "cm"),
        axis.ticks.length.y = unit(0.15, "cm"))
Angle_x <- theme(axis.text.x = element_text(angle = 45, hjust = 1))
#
PlotTitle <- theme(plot.title = element_text(size = 13, family = "serif", margin = margin(b = 0.07, t = 0)))
#
#Color to station number
Stat_pal <- c(rgb(0, 0, 228, maxColorValue = 255), rgb(153, 0, 0, maxColorValue = 255), rgb(0, 118, 0, maxColorValue = 255), rgb(102, 0, 102, maxColorValue = 255), rgb(245, 0, 0, maxColorValue = 255), rgb(76, 153, 0, maxColorValue = 255), rgb(255, 128, 0, maxColorValue = 255), rgb(127, 0, 255, maxColorValue = 255))
Stations <- c("1" = "Station 1", "2" = "Station 2", "3" = "Station 3", "4" = "Station 4", 
              "5" = "Station 5", "6" = "Station 6", "7" = "Station 7", "8" = "Station 8") 
Station_fill <- scale_fill_manual("", labels = Stations, values = setNames(Stat_pal, 1:8), na.value = "#999999")
Station_color <- scale_color_manual("", labels = Stations, values = setNames(Stat_pal, 1:8), na.value = "#999999")
#
theme_f <- theme(strip.text = element_text(color = "black", family = "serif", size = 11, face = "bold"),
                 strip.background = element_rect(fill = "#999999"),
                 panel.spacing = unit(0.75, "lines"))
#
```

```{r Dataframe cleaning, include=FALSE}
#
TripInfo <- TripInfo %>% mutate(TripDate = as.Date(TripDate))
#
Locations <- FixedLocations %>% 
  mutate(Station = as.numeric(StationNumber)) %>% 
  dplyr::select(FixedLocationID, Estuary, SectionName, Station) %>% distinct()  
#
##Measurements per cup/sample - filtration
Sediment <- SedimentTrap %>% filter(is.na(Volume)) %>% 
  mutate(Proportion = (CrucibleDW-TareCrucible)/((PanDryWeight - PanTareWeight) + (FilterDryWeight - FilterTareWeight))) %>%
  mutate(DeployedDate = as.Date(DeployedDate), 
         RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"), 
         NumDays = as.numeric(RetDate-DeployedDate),
         FixedLocationID = substring(SampleEventID, 19, 22), 
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         Plot_Date = as.Date(AnalysisDate + 14),
         Proportion = round((CrucibleDW-TareCrucible)/((PanDryWeight-PanTareWeight)+(FilterDryWeight-FilterTareWeight)),3),
         Type = as.factor(case_when(is.na(Proportion) ~ "Estimated", TRUE ~ "Calculated")),
         TotalTare = PanTareWeight + FilterTareWeight,
         TotalDW = (PanDryWeight - PanTareWeight) + (FilterDryWeight - FilterTareWeight),
         SampleAsh = AshWeight - TareCrucible,
         TotalAsh = case_when(is.na(Proportion) ~SampleAsh*(1/PortionofSample), TRUE ~ SampleAsh*(1/Proportion)),
         SampleOrgWt = case_when(is.na(Proportion) ~ (TotalDW-TotalAsh)*PortionofSample, TRUE ~ (TotalDW-TotalAsh)*Proportion),
         TotalOrgWt = TotalDW-TotalAsh,
         PctOrganic = TotalOrgWt/TotalDW *100) %>% #SamplePctOrg is the same ratio.
  dplyr::select(CupSampleID, FixedLocationID,SampleEventID, DeployedDate,RetDate, AnalysisDate, Plot_Date, NumDays, Proportion, PortionofSample, Type, TotalTare, TotalDW, CrucibleDW, SampleAsh, TotalAsh, SampleOrgWt, TotalOrgWt, PctOrganic) %>% 
  left_join(Locations, by = c("FixedLocationID")) %>%
  mutate(across(all_of(c("SampleOrgWt", "TotalOrgWt", "PctOrganic")), ~ifelse(.x < 0, 0, .x))) 
#
##Measurements per cup/sample - volumetrics
Volumes <- SedimentTrap %>% filter(!is.na(Volume)) %>% 
  dplyr::select(CupSampleID:DeployedDate, Volume, NumDrills:Comments) %>%
  mutate(DeployedDate = as.Date(DeployedDate), 
         RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"), 
         NumDays = as.numeric(RetDate-DeployedDate),
         FixedLocationID = substring(SampleEventID, 19, 22), 
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         Plot_Date = as.Date(AnalysisDate + 14)) %>% 
  dplyr::select(CupSampleID, FixedLocationID,SampleEventID, DeployedDate,RetDate, AnalysisDate, Plot_Date, NumDays, Volume) %>%
  left_join(Locations, by = c("FixedLocationID")) 
#
##Water quality data
SampleWQ <- SampleEventWQ %>% 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"), 
         FixedLocationID = substring(SampleEventID, 19, 22), 
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         Plot_Date = as.Date(AnalysisDate + 14),
         SecchiPercent = (Secchi / Depth) * 100) %>%
  dplyr::select(SampleEventWQID, FixedLocationID, SampleEventID, RetDate, AnalysisDate, Plot_Date, Temperature, Salinity, DissolvedOxygen, PercentDissolvedOxygen, pH, SecchiPercent, TurbidityYSI, TurbidityHach) %>%  
  left_join(Locations, by = c("FixedLocationID")) 
#
#
#
```

```{r Sediment monthly summaries, include=FALSE}
#
#Sample = numbers for crucible sample; Other is calculated to whole collection based on calculated proportion of sample used
#Estimated = estimate portion, Calculate = calculated proportion
Month_sedi <- Sediment %>% mutate(Station = as.factor(Station)) %>%
  group_by(AnalysisDate, Plot_Date, RetDate, FixedLocationID, Estuary, SectionName, Station, Type) %>% drop_na(TotalDW) %>% 
                          summarise(MeanRate = mean(TotalDW/(NumDays/28), na.rm = T),
                                    RateSD = sd(TotalDW/(NumDays/28), na.rm = T),
                                    SampleMeanOrgWt = mean(SampleOrgWt/(NumDays/28), na.rm = T),
                                    SampleSDOrgWt = sd(SampleOrgWt/(NumDays/28), na.rm = T),
                                    MeanOrgWt = mean(TotalOrgWt/(NumDays/28), na.rm = T),
                                    SDOrgWt = sd(TotalOrgWt/(NumDays/28), na.rm = T),
                                    MeanPctOrg = mean(PctOrganic, na.rm = T),
                                    SDPctOrg = sd(PctOrganic, na.rm = T)) %>%
  mutate(Year = format(AnalysisDate, "%Y"), Month = format(AnalysisDate, "%m"))
#
Month_vol <- Volumes %>% mutate(Station = as.factor(Station)) %>% group_by(AnalysisDate, Plot_Date, RetDate, FixedLocationID, Estuary, SectionName, Station) %>% summarise(MonthVol = mean(Volume/(NumDays/28), na.rm = T))
#
Sedi_rate <- Month_sedi %>% ungroup() %>% dplyr::select(Estuary, Station, RetDate, contains("Rate")) %>% mutate(Helper = case_when(is.na(MeanRate) ~ "*", TRUE ~ NA))
#
Sedi_PctOrg <- Month_sedi %>% ungroup() %>% dplyr::select(Estuary, Station, RetDate, contains("Pct")) %>% mutate(SampleHelper = case_when(is.na(MeanPctOrg) ~ "*", TRUE ~ NA), Helper = case_when(is.na(MeanPctOrg) ~ "*", TRUE ~ NA))
#
Sedi_OrgWt <- Month_sedi %>% ungroup() %>% dplyr::select(Estuary, Station, RetDate, contains("Wt")) %>% mutate(SampleHelper = case_when(is.na(SampleMeanOrgWt) ~ "*", TRUE ~ NA), Helper = case_when(is.na(MeanOrgWt) ~ "*", TRUE ~ NA))
#
```

```{r Sediment trap summary tables, include=FALSE}
#
SedimentSumm_overall <- rbind(Sediment %>% 
  group_by(Estuary) %>%
  summarise(MeanRate = mean(TotalDW/(NumDays/28), na.rm = T),  sdRate = sd(TotalDW/(NumDays/28), na.rm = T),
            MinRate = min(TotalDW/(NumDays/28), na.rm = T), MaxRate = max(TotalDW/(NumDays/28), na.rm = T)) %>% mutate(Station = NA),
  Sediment %>% 
    group_by(Estuary, Station) %>%
    summarise(MeanRate = mean(TotalDW/(NumDays/28), na.rm = T),  sdRate = sd(TotalDW/(NumDays/28), na.rm = T),
              MinRate = min(TotalDW/(NumDays/28), na.rm = T), MaxRate = max(TotalDW/(NumDays/28), na.rm = T))) %>%
  arrange(Estuary, Station) %>% dplyr::select(Estuary, Station, everything()) 
#
PctOrgSumm_overall <- rbind(Sediment %>% 
  group_by(Estuary) %>%
  summarise(MeanPct = mean(PctOrganic, na.rm = T), sdPct = sd(PctOrganic, na.rm = T),
            MinPct = min(PctOrganic, na.rm = T), MaxPct = max(PctOrganic, na.rm = T)) %>% mutate(Station = NA),
  Sediment %>% 
    group_by(Estuary, Station) %>%
    summarise(MeanPct = mean(PctOrganic, na.rm = T),  sdPct = sd(PctOrganic, na.rm = T),
              MinPct = min(PctOrganic, na.rm = T), MaxPct = max(PctOrganic, na.rm = T))) %>%
  arrange(Estuary, Station) %>% dplyr::select(Estuary, Station, everything()) 
#
OrgWtSumm_overall <- rbind(Sediment %>% 
  group_by(Estuary) %>%
  summarise(MeanWt = mean(TotalOrgWt/(NumDays/28), na.rm = T), sdWt = sd(TotalOrgWt/(NumDays/28), na.rm = T),
            MinWt = min(TotalOrgWt/(NumDays/28), na.rm = T), MaxWt = max(TotalOrgWt/(NumDays/28), na.rm = T),
            MeanSample = mean(SampleOrgWt/(NumDays/28), na.rm = T), sdSample = sd(SampleOrgWt/(NumDays/28), na.rm = T),
            MinSample = min(SampleOrgWt/(NumDays/28), na.rm = T), MaxSample = max(SampleOrgWt/(NumDays/28), na.rm = T)) %>% mutate(Station = NA),
  Sediment %>% 
    group_by(Estuary, Station) %>%
    summarise(MeanWt = mean(TotalOrgWt/(NumDays/28), na.rm = T), sdWt = sd(TotalOrgWt/(NumDays/28), na.rm = T),
            MinWt = min(TotalOrgWt/(NumDays/28), na.rm = T), MaxWt = max(TotalOrgWt/(NumDays/28), na.rm = T),
            MeanSample = mean(SampleOrgWt/(NumDays/28), na.rm = T), sdSample = sd(SampleOrgWt/(NumDays/28), na.rm = T),
            MinSample = min(SampleOrgWt/(NumDays/28), na.rm = T), MaxSample = max(SampleOrgWt/(NumDays/28), na.rm = T))) %>%
  arrange(Estuary, Station) %>% dplyr::select(Estuary, Station, everything()) 
#

#Lowest and highest sedimentation rate, % organic, and organic weight per station
MinMax_stations <- rbind(rbind(Month_sedi %>% group_by(Estuary, Station) %>% slice_min(order_by = MeanRate, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanRate) %>% mutate(Type = "Min Rate", Measure = "Sedimentation") %>% rename(Value = MeanRate),
                               Month_sedi %>% group_by(Estuary, Station) %>% slice_max(order_by = MeanRate, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanRate) %>% mutate(Type = "Max Rate", Measure = "Sedimentation") %>% rename(Value = MeanRate)),
                         rbind(Month_sedi %>% group_by(Estuary, Station) %>% slice_min(order_by = MeanPctOrg, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanPctOrg) %>% mutate(Type = "Min Percent", Measure = "Percent Organic") %>% rename(Value = MeanPctOrg),
                               Month_sedi %>% group_by(Estuary, Station) %>% slice_max(order_by = MeanPctOrg, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanPctOrg) %>% mutate(Type = "Max Percent", Measure = "Percent Organic") %>% rename(Value = MeanPctOrg)),
                         rbind(Month_sedi %>% group_by(Estuary, Station) %>% slice_min(order_by = MeanOrgWt, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanOrgWt) %>% mutate(Type = "Min Daily Org Wt", Measure = "Organic Weight") %>% rename(Value = MeanOrgWt),
                               Month_sedi %>% group_by(Estuary, Station) %>% slice_max(order_by = MeanOrgWt, na_rm = T) %>% dplyr::select(Year, Month, Estuary, Station, MeanOrgWt) %>% mutate(Type = "Max Daily Org Wt", Measure = "Organic Weight") %>% rename(Value = MeanOrgWt))) %>%
  dplyr::select(Measure, Estuary, Station, Type, Year, Month, Value) %>% arrange(Measure, Estuary, Station)
#
```

This report provides summary tables and figures for the sediment trap data at Tampa Bay and Caloosahatchee River stations from `r format(as.Date(Report_start), "%B %Y")` through `r format(as.Date(Report_end), "%B %Y")`.
\
\
Monthly data is standardized to a 28-day month unless otherwise noted.
\
\
Overall values are based on all data summarizes together. Data is extrapolated to the entire sample collected in most cases. Columns including "Sample" in the title are from crucible data and not extrapolated to the entire sample collected.  
\
`r SedimentSumm_overall  %>% mutate(across(where(is.numeric), round, digits = 2)) %>% as_grouped_data(groups = "Estuary") %>% flextable() %>% align(align = "center") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 1. Sedimentation rates (g/month) by station and overall during the project. Rates are standardized to 28-day months.")`
\
`r PctOrgSumm_overall %>% mutate(across(where(is.numeric), round, digits = 2)) %>% as_grouped_data(groups = "Estuary") %>% flextable() %>% align(align = "center") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.55) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 2. Percent organic content (%) by station and overall during the project.")`
\
`r OrgWtSumm_overall %>% mutate(across(where(is.numeric), round, digits = 2)) %>% as_grouped_data(groups = "Estuary") %>% flextable() %>% align(align = "center") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.6) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 3. Organic weight (g/day) of sediment by station and overall during the project. Sample columns use crucible level data while other columns extrapolate measurements to the entire sample based on estimated or calculated proportions. Values are standardized to 28-day months.")`
\
`r MinMax_stations %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% merge_v(j = c("Measure", "Estuary", "Station")) %>% hline(part = "body") %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.65) %>% width(width = 1.2, j = c(1, 4)) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 4. Minimum and maximum sedimentation rates, percent organic content, and organic weight per station and the Month and Year in which the minimum or maximum occurred.")`
\
```{r Sedimentation rate, fig.cap = "**Figure 1.**  Mean monthly sedimentation rate (Â± S.D.) at stations in Tampa Bay and Caloosahatchee River. Asterisks indicate when no samples were collected from a station. Please note differences in magnitude between the y-axes.", fig.height = 9.5, fig.width = 8, fig.fullwidth=TRUE}
#
###Monthly sedimentation rate
Sedi_list <- list()
for(i in seq_along(Sites)){
  #
  Working_site <- paste(Sites[i])
  df_temp <- Sedi_rate %>% filter(grepl(Working_site, Estuary)) %>% rowwise() %>% mutate(Upper = sum(MeanRate, RateSD, na.rm = TRUE))
  df_temp$HelperLocation <- (ceiling(max(df_temp$Upper, na.rm = T)*1.05)/5)
  max_upper <- ceiling(max(df_temp$Upper, na.rm = T)*1.05) #*1.05 adds 5% buffer to top if needed
  #
  Sedi_list[[i]] <- df_temp %>% ggplot(aes(RetDate, MeanRate, fill = Station, color = Station))+ 
    geom_errorbar(aes(ymin = MeanRate, ymax = MeanRate + RateSD), color = "black", position = position_dodge(12, preserve = "single"), width = 9) +
    geom_col(position = position_dodge(12, preserve = "single"), width = 9) +
    geom_text(aes(y = HelperLocation, label = Helper, color = Station), position = position_dodge(12, preserve = "single"), size = 8) +
    scale_x_date("Date", expand= c(0.005,0), date_breaks = "2 months", date_labels = "%b %Y", limits = c(floor_date(min(TripInfo$TripDate), "month"), ceiling_date(max(TripInfo$TripDate), "month") %m-% days(1)))+
    scale_y_continuous("Sedimentation rate (g/month)", expand = c(0,0), limits = c(0, max(pretty(0:ceiling(max_upper*10)/10))), breaks = pretty(0:ceiling(max_upper*10)/10))+
    ggtitle(paste0(case_when(grepl("TB", Working_site) ~ "Tampa Bay", grepl("CR", Working_site) ~ "Caloosahatchee River", TRUE ~ "WRONG"))) +
    Station_fill + Station_color + BaseForm + PlotTitle + Angle_x
}

Sedi_rate_fig <- ggarrange(
  Sedi_list[[1]] + rremove("x.text") + rremove("x.title") + rremove("y.title") + guides(color = guide_legend(override.aes = list(size=2))),
  Sedi_list[[2]] + rremove("x.title") + rremove("y.title") + guides(color = guide_legend(override.aes = list(size=2))),
  nrow = 2, heights = c(1, 1.1), align = "v"  
  )

annotate_figure(Sedi_rate_fig, left = text_grob("Sedimentation Rate (g/month)", rot = 90, vjust = 0.4, family = "serif", size = 18, color = "black"))

```


```{r Percent organic per total sample, fig.cap = "**Figure 2.**  Monthly organic content (%) of sediment at stations in Tampa Bay and Caloosahatchee River. Values are extrapolated to the entire samples. Asterisks indicate when no samples were collected from a station.", fig.height = 9.5, fig.width = 8, fig.fullwidth=TRUE}
#
Sedi_org_list <- list()
for(i in seq_along(Sites)){
  #
  Working_site <- paste(Sites[i])
  df_temp <- Sedi_PctOrg %>% filter(grepl(Working_site, Estuary))
  max_upper <- ceiling(max((df_temp %>% rowwise() %>% mutate(Upper = sum(MeanPctOrg, SDPctOrg, na.rm = TRUE)))$Upper, na.rm = T)*1.05) #*1.05 adds 5% buffer to top if needed
  df_temp$HelperLocation <- (ceiling(max((df_temp %>% rowwise() %>% mutate(Upper = sum(MeanPctOrg, SDPctOrg, na.rm = TRUE)))$Upper, na.rm = T)*1.05))/5
  #
  Sedi_org_list[[i]] <- df_temp %>% ggplot(aes(RetDate, MeanPctOrg, fill = Station, color = Station))+ 
    geom_errorbar(aes(ymin = MeanPctOrg, ymax = MeanPctOrg + SDPctOrg), color = "black", position = position_dodge(13, preserve = "single"), width = 12) +
    geom_col(position = position_dodge(13, preserve = "single"), width = 10, color = "black") +
    geom_text(aes(y = HelperLocation, label = Helper, color = Station), position = position_dodge(13, preserve = "single"), size = 8) +
    scale_x_date("Date", expand= c(0,0), date_breaks = "2 months", date_labels = "%b %Y", limits = c(as.Date("2023-04-05"), ceiling_date(max(TripInfo$TripDate), "month") %m-% days(1)))+
    scale_y_continuous("Organic Content (%)", expand = c(0,0), limits = c(0, max(pretty(0:ceiling(max_upper*10)/10))), breaks = pretty(0:ceiling(max_upper*10)/10))+
    ggtitle(paste0(case_when(grepl("TB", Working_site) ~ "Tampa Bay", grepl("CR", Working_site) ~ "Caloosahatchee River", TRUE ~ "WRONG"))) +
    Station_fill + Station_color + BaseForm + PlotTitle + Angle_x
}

Sedi_org_fig <- ggarrange(
  Sedi_org_list[[1]] + rremove("x.text") + rremove("x.title") + rremove("y.title") + guides(color = guide_legend(override.aes = list(size=2))),
  Sedi_org_list[[2]] + rremove("x.title") + rremove("y.title") + guides(color = guide_legend(override.aes = list(size=2))),
  nrow = 2, heights = c(1, 1.1), align = "v"  
  )

annotate_figure(Sedi_org_fig, left = text_grob("Organic Content (%)", rot = 90, vjust = 0.4, family = "serif", size = 18, color = "black"))

```

```{r Sedimentation comparisons - estuary and station, include=FALSE}
#
#Visualize
ggboxplot(Month_sedi, x = "Estuary", y = "MeanRate", color = "Station")
Month_sedi %>% ggplot(aes(x = MeanRate))+ geom_histogram(aes(y = ..count..)) #right-skewed + zeros - log(x+1)
Month_sedi %>% ggplot(aes(x = log10(MeanRate+1)))+ geom_histogram(aes(y = ..count..))
Month_sedi2 <- Month_sedi %>% mutate(logRate = log10(MeanRate + 1),
                                     Estuary = as.factor(Estuary),
                                     Station_code = factor(paste0(Estuary, Station))) %>% ungroup()
#
##Permutation 2 factor Anova
set.seed(402)
Sedi_aov <- aovp(logRate ~ Estuary + Station_code, data = Month_sedi2, perm = "",  nperm = 10000)
summary(Sedi_aov)
Sedi_aov_tidy <- tidy(Sedi_aov)
names(Sedi_aov_tidy) <- c("Factors", "df", "SS", "MS", "F", "Pr")
#
Sedi_est_tab <- pairwisePermutationTest(logRate ~ Estuary, data = Month_sedi2, method = "fdr", alternative = "two.sided") 
Sedi_estuary <- merge(Month_sedi2 %>% group_by(Estuary) %>% get_summary_stats(MeanRate, type = "mean_sd") %>% dplyr::select(-c("variable")) %>% transform(lower = mean-sd, upper = mean+sd),
                      cldList(comparison = Sedi_est_tab$Comparison, p.value = Sedi_est_tab$p.adjust, threshold = 0.05) %>% select(-c("MonoLetter")) %>% rename(Estuary = Group, Letters = Letter))
Sedi_sta_tab <- pairwisePermutationTest(logRate ~ Station_code, data = Month_sedi2, method = "fdr", alternative = "two.sided") 
Sedi_station <- merge(Month_sedi2 %>% group_by(Station_code) %>% get_summary_stats(MeanRate, type = "mean_sd") %>% dplyr::select(-c("variable")) %>% transform(lower = mean-sd, upper = mean+sd),
                      cldList(comparison = Sedi_sta_tab$Comparison, p.value = Sedi_sta_tab$p.adjust, threshold = 0.05) %>% select(-c("MonoLetter")) %>% rename(Station_code = Group, Letters = Letter))
#
#
```
\
`r Sedi_aov_tidy %>% mutate_at(vars(SS, MS, F), round, digits = 2) %>% mutate_at(vars(Pr), round, digits = 3) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% width(width = 1, j = 1.1) %>% padding(padding = 1.2, part = "all") %>% color(i = ~ Pr < 0.05, j = "Pr", color = "red") %>% set_caption("Table 5. Analysis of sedimentation rates (g/month) by estuary and station. Permutation ANOVA using 10,000 permutations.")`
\
`r Sedi_estuary  %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 6. Mean sedimentation rates (g/month) per estuary. Letters are determined based on pairwise permutation two-sample independence analysis.")`
\
`r Sedi_est_tab %>% mutate_at(vars(p.value, p.adjust), as.numeric) %>% mutate(across(where(is.numeric), round, digits = 3)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% width(width = 1, j = 1) %>% padding(padding = 1.2, part = "all") %>% color(i = ~ p.adjust < 0.05, j = "p.adjust", color = "red") %>% set_caption("Table 7. Pairwise two-sample permutation post-hoc comparisons of sedimentation rates (g/month) per estuary.")`
\
`r Sedi_station %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 8. Mean sedimentation rates (g/month) per station. Letters are determined based on pairwise permutation two-sample independence analysis.")`
\
`r Sedi_sta_tab %>% mutate_at(vars(p.value, p.adjust), as.numeric) %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% width(width = 1, j = 1) %>% padding(padding = 1.2, part = "all") %>% color(i = ~ p.adjust < 0.05, j = "p.adjust", color = "red") %>% set_caption("Table 9. Pairwise two-sample permutation post-hoc comparisons of sedimentation rates (g/month) per station.")`
\
```{r Monthly sedimentation rate figure, fig.cap = "**Figure 4.**  Mean monthly sedimentation rates at stations in Tampa Bay and Caloosahatchee River. Colors indicate significant groupings (alpha = 0.05). Rates are standarized to a 28-day month.", fig.height = 9.5, fig.width = 8, fig.fullwidth=TRUE}

Month_sedi2 %>% group_by(Estuary, Station_code) %>% left_join(Sedi_station[c(1,7)]) %>% 
  ggplot(aes(Station, MeanRate, fill = Letters)) + geom_boxplot() +
  lemon::facet_rep_grid(.~Estuary, scales = "free_x") +
  scale_y_continuous("Mean monthly sedimentation rate (g/month)", expand = c(0,0), limits = c(0, 1000))+
  BaseForm + theme_f

```

```{r Percent organic comparisons crucible - estuary and station, include=FALSE}
#
#Visualize
ggboxplot(Month_sedi, x = "Estuary", y = "SampleMeanOrganic", color = "Station")
Month_sedi %>% ggplot(aes(x = SampleMeanOrganic))+ geom_histogram(aes(y = ..count..)) #left-skewed-percentages
#
##Permutation 2 factor Anova
set.seed(402)
Org_aov <- aovp(SampleMeanOrganic ~ Estuary + Station_code, data = Month_sedi2, perm = "",  nperm = 10000)
summary(Org_aov)
Org_aov_tidy <- tidy(Org_aov)
names(Org_aov_tidy) <- c("Factors", "df", "SS", "MS", "F", "Pr")
#
Org_est_tab <- pairwisePermutationTest(SampleMeanOrganic ~ Estuary, data = Month_sedi2, method = "fdr", alternative = "two.sided") 
Org_estuary <- merge(Month_sedi2 %>% group_by(Estuary) %>% get_summary_stats(SampleMeanOrganic, type = "mean_sd") %>% dplyr::select(-c("variable")) %>% transform(lower = mean-sd, upper = mean+sd),
                      cldList(comparison = Org_est_tab$Comparison, p.value = Org_est_tab$p.adjust, threshold = 0.05) %>% select(-c("MonoLetter")) %>% rename(Estuary = Group, Letters = Letter))
Org_sta_tab <- pairwisePermutationTest(SampleMeanOrganic ~ Station_code, data = Month_sedi2, method = "fdr", alternative = "two.sided") 
Org_station <- merge(Month_sedi2 %>% group_by(Station_code) %>% get_summary_stats(SampleMeanOrganic, type = "mean_sd") %>% dplyr::select(-c("variable")) %>% transform(lower = mean-sd, upper = mean+sd),
                      cldList(comparison = Org_sta_tab$Comparison, p.value = Org_sta_tab$p.adjust, threshold = 0.05) %>% select(-c("MonoLetter")) %>% rename(Station_code = Group, Letters = Letter))
#
#
```
\
`r Org_aov_tidy %>% mutate_at(vars(SS, MS, F), round, digits = 2) %>% mutate_at(vars(Pr), round, digits = 3) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% width(width = 1.1, j = 1) %>% padding(padding = 1.2, part = "all") %>% color(i = ~ Pr < 0.05, j = "Pr", color = "red") %>% set_caption("Table 10. Analysis of organic content (%) of crucible samples by estuary and station. Permutation ANOVA using 10,000 permutations.")`
\
`r Org_estuary  %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 11. Mean organic content (%) of crucible samples per estuary. Letters are determined based on pairwise permutation two-sample independence analysis.")`
\
`r Org_est_tab %>% mutate_at(vars(p.value, p.adjust), as.numeric) %>% mutate(across(where(is.numeric), round, digits = 3)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% width(width = 1, j = 1) %>% padding(padding = 1.2, part = "all") %>% color(i = ~ p.adjust < 0.05, j = "p.adjust", color = "red") %>% set_caption("Table 12. Pairwise two-sample permutation post-hoc comparisons of organic content (%) in crucible samples per estuary.")`
\
`r Org_station %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 13. Mean organic content (%) in crucible samples per station. Letters are determined based on pairwise permutation two-sample independence analysis.")`
\
`r Org_sta_tab %>% mutate_at(vars(p.value, p.adjust), as.numeric) %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% width(width = 1, j = 1) %>% padding(padding = 1.2, part = "all") %>% color(i = ~ p.adjust < 0.05, j = "p.adjust", color = "red") %>% set_caption("Table 14. Pairwise two-sample permutation post-hoc comparisons of organic content (%) in crucible samples per station.")`
\
```{r Monthly percent organic crucible figure, fig.cap = "**Figure 5.**  Mean monthly percent organic content in crucible samples from stations in Tampa Bay and Caloosahatchee River. Colors indicate significant groupings (alpha = 0.05). Rates are standarized to a 28-day month.", fig.height = 9.5, fig.width = 8, fig.fullwidth=TRUE}
#
Month_sedi2 %>% group_by(Estuary, Station_code) %>% left_join(Org_station[c(1,7)]) %>% 
  ggplot(aes(Station, SampleMeanOrganic, fill = Letters)) + geom_boxplot() +
  lemon::facet_rep_grid(.~Estuary, scales = "free_x") +
  scale_y_continuous("Mean monthly organic content (%)", expand = c(0,0), limits = c(0, 100))+
  BaseForm + theme_f
#
```

```{r Percent organic comparisons  - estuary and station, include=FALSE}
#
#Visualize
ggboxplot(Month_sedi, x = "Estuary", y = "MeanOrganic", color = "Station") #Potential for outliers
Month_sedi %>% ggplot(aes(x = MeanOrganic))+ geom_histogram(aes(y = ..count..)) #right-skewed-percentages
Month_sedi2 %>% group_by(Estuary, Station_code) %>% identify_outliers(MeanOrganic) %>% filter(is.extreme == TRUE)
#
##Permutation 2 factor Anova
set.seed(402)
Org_all_aov <- aovp(MeanOrganic ~ Estuary + Station_code, data = Month_sedi2, perm = "",  nperm = 10000)
summary(Org_all_aov)
Org_all_aov_tidy <- tidy(Org_all_aov)
names(Org_all_aov_tidy) <- c("Factors", "df", "SS", "MS", "F", "Pr")
#
Org_all_est_tab <- pairwisePermutationTest(MeanOrganic ~ Estuary, data = Month_sedi2, method = "fdr", alternative = "two.sided") 
Org_all_estuary <- merge(Month_sedi2 %>% group_by(Estuary) %>% get_summary_stats(MeanOrganic, type = "mean_sd") %>% dplyr::select(-c("variable")) %>% transform(lower = mean-sd, upper = mean+sd),
                      cldList(comparison = Org_all_est_tab$Comparison, p.value = Org_all_est_tab$p.adjust, threshold = 0.05) %>% select(-c("MonoLetter")) %>% rename(Estuary = Group, Letters = Letter))
Org_all_sta_tab <- pairwisePermutationTest(MeanOrganic ~ Station_code, data = Month_sedi2, method = "fdr", alternative = "two.sided") 
Org_all_station <- merge(Month_sedi2 %>% group_by(Station_code) %>% get_summary_stats(MeanOrganic, type = "mean_sd") %>% dplyr::select(-c("variable")) %>% transform(lower = mean-sd, upper = mean+sd),
                      cldList(comparison = Org_all_sta_tab$Comparison, p.value = Org_all_sta_tab$p.adjust, threshold = 0.05) %>% select(-c("MonoLetter")) %>% rename(Station_code = Group, Letters = Letter))
#
#
```
\
`r Org_all_aov_tidy %>% mutate_at(vars(SS, MS, F), round, digits = 2) %>% mutate_at(vars(Pr), round, digits = 3) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% width(width = 1.1, j = 1) %>% padding(padding = 1.2, part = "all") %>% color(i = ~ Pr < 0.05, j = "Pr", color = "red") %>% set_caption("Table 15. Analysis of organic content (%) extrapolated to entire samples by estuary and station. Accurate proportion calculations began in April 2024 Permutation ANOVA using 10,000 permutations.")`
\
`r Org_all_estuary  %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 16. Mean organic content (%) extrapolated to entire samples per estuary. Letters are determined based on pairwise permutation two-sample independence analysis.")`
\
`r Org_all_est_tab %>% mutate_at(vars(p.value, p.adjust), as.numeric) %>% mutate(across(where(is.numeric), round, digits = 3)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% width(width = 1, j = 1) %>% padding(padding = 1.2, part = "all") %>% color(i = ~ p.adjust < 0.05, j = "p.adjust", color = "red") %>% set_caption("Table 17. Pairwise two-sample permutation post-hoc comparisons of organic content (%) extrapolated to entire samples per estuary.")`
\
`r Org_all_station %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% padding(padding = 1.2, part = "all") %>% set_caption("Table 18. Mean organic content (%) extrapolated to entire samples per station. Letters are determined based on pairwise permutation two-sample independence analysis.")`
\
`r Org_all_sta_tab %>% mutate_at(vars(p.value, p.adjust), as.numeric) %>% mutate(across(where(is.numeric), round, digits = 2)) %>% flextable() %>% align(align = "center", part = "all") %>% font(fontname = "Arial", part = "all") %>% fontsize(size = 10, part = "all") %>% bold(bold = T, part = "header") %>% width(width = 0.7) %>% width(width = 1, j = 1) %>% padding(padding = 1.2, part = "all") %>% color(i = ~ p.adjust < 0.05, j = "p.adjust", color = "red") %>% set_caption("Table 19. Pairwise two-sample permutation post-hoc comparisons of organic content (%) extrapolated to entire samples per station.")`
\
```{r Monthly percent organic all sample figure, fig.cap = "**Figure 6.**  Mean monthly percent organic content extrapolated to entire sample from stations in Tampa Bay and Caloosahatchee River. Colors indicate significant groupings (alpha = 0.05). Rates are standarized to a 28-day month.", fig.height = 9.5, fig.width = 8, fig.fullwidth=TRUE}
#
Month_sedi2 %>% group_by(Estuary, Station_code) %>% left_join(Org_all_station[c(1,7)]) %>% 
  ggplot(aes(Station, MeanOrganic, fill = Letters)) + geom_boxplot() +
  lemon::facet_rep_grid(.~Estuary, scales = "free_x") +
  scale_y_continuous("Mean monthly organic content (%)", expand = c(0,0), limits = c(0, 25))+
  BaseForm + theme_f
#
```